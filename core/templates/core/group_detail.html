{% extends 'core/base.html' %}
{% block title %}Group: {{ group.name }}{% endblock %}

{% block content %}
  <h2 class="main_h2">{{ group.name }}</h2>
  <p style="text-align: center;">{{ group.description }}</p>

  {% if request.user != group.created_by %}
    <p class="form-link">
      <a href="{% url 'request_to_join' group.id %}">Request to join</a>
    </p>
  {% endif %}

  {% if request.user == group.created_by %}
    <h3 class="main_h2" style="font-size: 30px;">Pending Requests</h3>
    {% if group.join_requests.all %}
      <ul class="wallet-assets">
        {% for req in group.join_requests.all %}
          {% if not req.is_approved %}
            <li>
              {{ req.user.username }}
              <p class="form-link">
                <a href="{% url 'approve_request' group.id req.id %}">Accept</a> |
                <a href="{% url 'reject_request' group.id req.id %}">Reject</a>
              </p>
            </li>
          {% endif %}
        {% empty %}
          <li>No pending requests</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endif %}

  <h3 class="main_h2" style="font-size: 30px;">Ranking</h3>
  <table class="wallet-assets" style="width:100%; text-align:left;">
    <tr>
      <th>User</th>
      <th>Balance</th>
      <th>Total portfolio</th>
    </tr>
    {% for member in members %}
      <tr>
        <td>{{ member.user.username }}</td>
        <td>{{ member.balance }}</td>
        <td>{{ member.portfolio_value }}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="3">No members</td>
      </tr>
    {% endfor %}
  </table>

  {% if request.user == group.created_by %}
    <p class="form-link">
      <a href="{% url 'distribute_balance' group.id %}">Distribute balance</a>
    </p>
  {% endif %}

  {% if membership %}
    <p class="form-link">
      <a href="{% url 'buy_asset_in_group' group.id %}">Buy assets</a>
    </p>
  {% endif %}

  <h3 class="main_h2" style="font-size: 30px;">Group asset purchases</h3>
  <ul class="wallet-assets">
    {% with total_purchases=0 %}
      {% for membership in group.membership_set.all %}
        {% for p in membership.groupassetpurchase_set.all %}
          <li>
            {{ p.membership.user.username }} bought {{ p.quantity }}
            {{ p.asset.symbol }} at {{ p.price_at_purchase }}$
            ({{ p.created_at }})
          </li>
        {% endfor %}
      {% endfor %}
      {% if total_purchases == 0 %}
        <li>No purchases yet</li>
      {% endif %}
    {% endwith %}
  </ul>

  <p class="form-link">
    <a href="{% url 'group_list' %}">Back to groups</a>
  </p>
{% endblock %}
